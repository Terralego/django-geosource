dist: bionic
sudo: required
language: python
python:
- '3.6'
- '3.7'
env:
  matrix:
  - DJANGO_VERSION=2.2 REST_VERSION=3.8
  - DJANGO_VERSION=2.2 REST_VERSION=3.9
  - DJANGO_VERSION=2.2 REST_VERSION=3.10
services:
- postgresql
addons:
  postgresql: '10'
  apt:
    packages:
    - postgresql-10-postgis-2.4
    - postgresql-10-pgrouting
stages:
- lint
- test
- deploy
install:
- sudo apt-get -y install libproj-dev binutils gdal-bin
- pip install -e .[dev]
- pip install codecov
- if [[ $DJANGO_VERSION == dev ]]; then pip install -e git+https://github.com/django/django@master#egg=django;
  else pip install Django==$DJANGO_VERSION -U; fi
- if [[ $REST_VERSION == dev ]]; then pip install -e git+https://github.com/encode/django-rest-framework.git@master#egg=django-rest-framework;
  else pip install djangorestframework==$REST_VERSION -U; fi
before_script:
- psql -c "CREATE USER travis_ci_test WITH ENCRYPTED PASSWORD 'travis_ci_test';" -U
  postgres
- psql -c "ALTER USER travis_ci_test WITH SUPERUSER;" -U postgres
- psql -c 'CREATE DATABASE travis_ci_test WITH OWNER travis_ci_test;' -U postgres
- psql -d travis_ci_test -c 'CREATE EXTENSION postgis;'
- psql -d travis_ci_test -c 'CREATE EXTENSION pgrouting;'
after_failure:
- pip freeze
script:
- coverage run ./manage.py test
- codecov
jobs:
  include:
  - stage: lint
    install:
    - pip install flake8
    script:
    - flake8 geostore
  - stage: deploy
    install: skip
    before_script: skip
    script: skip
    deploy:
      stage: deploy
      provider: pypi
      user: __token__
      password:
        secure: ocbphtRPcuiK/x1KFRgpZpua1qaEV+8J0ELC1N3EJ5gZDszIsRBTrUqPPkL2CjK8qwcwJqgD2KwmQzp9qwlQe/dejlFRqIaeuDpazmUmfqd/47DHjOzMXXDtMKS6bCiTUeJESKCEn5fb4aFitiAq9BWq9uQg1JfxKMPGYJh0Vlm2jgBMo+ZF+ygoSPoMBCDpV4DB9Yp0W+QkpESMgmeN72r60z9/2o+zsbHuyfadVBo6oDYa6hXO/xUP7dHHE+JgVk9oZ3br9kuMpOxGdIH8YjYVdFvPUVEZoUDYUNFiJ6L4hrbTUOYtPX29n+6zdwatoPWpwjItMDANf/1cWAsvXF1CHlz+COXoUbwI2VyomS6beg1Arm5NY7B9IJoUy9OOxTD45dSs3EEmktpFEdzs0t4d0HobotlnFGiwbUQ1X21VDlzYIVBYh4J1FaDZPA6COkEDBEYq3//6ouVL1ldYt1lgUjDdfxRyV8RB9EWOGvJQeONcaBZ1z1CnlSBYEtLz4NG9vmxlmj1Y62PPdu6R7uf/SQUyYXjY4uL5wzodwm6GDruNvQYcZuYt11cH7JzfL1OK+co8HdFQpvZnmJOo2FJkjZ0eUdBQmKFyfF2PSXq+YB6WCKb9/VruI1xZoD1CJGLRqrD6Y7KEWGekL+r2EPy1lqdToJWCD2mnvss/Uyw=
      on:
        tags: true

dist: bionic
sudo: required
language: python
python:
  - '3.6'
  - '3.7'
  - '3.8'

env:
  matrix:
    - DJANGO_VERSION=2.2.*
    - DJANGO_VERSION=3.0.*
    - DJANGO_VERSION=dev

services:
  - postgresql

addons:
  postgresql: '10'
  apt:
    packages:
      - postgresql-10-postgis-2.4
      - postgresql-10-pgrouting

stages:
  - lint
  - test
  - deploy

install:
  - sudo apt-get -y install libproj-dev binutils gdal-bin libgdal-dev
  - pip install -e .[dev]
  - pip install codecov
  - if [[ $DJANGO_VERSION == dev ]]; then pip install -e git+https://github.com/django/django@master#egg=django;
    else pip install Django==$DJANGO_VERSION -U; fi

before_script:
  - psql -c "CREATE USER travis_ci_test WITH ENCRYPTED PASSWORD 'travis_ci_test';" -U
    postgres
  - psql -c "ALTER USER travis_ci_test WITH SUPERUSER;" -U postgres
  - psql -c 'CREATE DATABASE travis_ci_test WITH OWNER travis_ci_test;' -U postgres
  - psql -d travis_ci_test -c 'CREATE EXTENSION postgis;'
  - psql -d travis_ci_test -c 'CREATE EXTENSION pgrouting;'

after_failure:
  - pip freeze

script:
  - coverage run ./manage.py test
  - codecov

jobs:
  allow_failures:
    - env: DJANGO_VERSION=dev

  include:
    - stage: lint
      install:
        - pip install black flake8
      script:
        - black --check django_geosource
        - flake8 django_geosource
    - stage: deploy
      install: skip
      before_script: skip
      script: skip
      deploy:
        stage: deploy
        provider: pypi
        user: __token__
        password:
          secure: jrGnKBj18FS7vcwJ8pmi7/9/EfVzncyjkpzTzoVjRIDbs9N773cpouueJUmD+H6JiLQBI2qaZ0ChcY8fb4MqEqN9MQdjtDFcmvLWkuvTsKq087pYXss0ZLikNP+rbv+xR53KF5yZTTxASUPQkcARqTfk9pCiRJSRLaSuWtQSlrBYt/fo3YvOcGAqoRyMWKRLgJGAabHmOAnWz37ZxSDr36MMfXpLb7FpT9YOS+mEdWog13wSwghUerVKbdjrK/IPtVjpeU3egqYu9P/Z3IoweWkcDEeDR46jxRpw8dU8P9RoFs4RkjQNrXvyKdgxMywQV3sgOiVakqKaXCZAAnshzvcmwt0cEslg5ciYqK2fHU2sXYHPfamThbyrj399WNwgK8B6EwM94YFsr1tAalZpfDWy1vjJ5pA1I2evf3MvlZDHLpoiFk4JKA/13IZIANgVE2c/s2zZL0gkwU8ZY0nROpVh3NwVLLs/QAtXnayKd31R0+5dczJKMgxdbvR2aRNAJ9f2VRdNx/mtJH1QW6M98R89Nt2CrFos2aPfay/C9pOyFIFBpM2OdiJsM1wMSRCmWh21+NhSQUiLzZP++g5uX7V7nseHA0Z51Vbf4AHHUXeDR2WHdJlklFtk1VnSBPex2sWrKHQPLDakrgtlbkzlT66+Lh2NZZ8qIh3XwwUXFF8=
        on:
          tags: true
